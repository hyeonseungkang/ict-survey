<html>
<head>
    <title>survey 본문</title>
    <style>
        body {
            font-family: "Apple SD Gothic Neo", sans-serif;
        }

        .main {
            text-align: center;
        }

        .main h1 {
            font-size: 1.8em;
        }

        .log {
            border: none;
            width: 80vw;
        }

        button {
            border: 1px gray solid;
            border-radius: 16px;
            box-shadow: 10px 10px 10px lightgray;
            background-color: rgba(0, 0, 0, 30%);
            color: black;
        }

        #survey-id button {
            width: 80vw;
            height: 6em;
            font-size: 1.4em;
        }

        button.response-btn {
            height: 70vh;
            width: 46vw;
            font-size: 2.8em;
            margin-right: 0.4em;
        }

        span#survey-id {
            font-size: 1.4em;
        }
    </style>
</head>
<body>
<div class="logged">
    <h1>
        <span id="survey-message">
            실험에 참여해주셔서 감사합니다. 아래의 버튼을 누르시어 실험에 참가할 수 있습니다. <br>
            Thank you for participate the survey. By click button below, you can join survey.
        </span><br>
    </h1>
    <span id="survey-id">
            <button>
                [버튼] 나는 실험 전에 동의서의 내용을 이해하였으며, 모든 내용을 동의함. <br>
                [Button] I understand the contents of the Consent form, and fully agree with the contents.
            </button>
    </span>
</div>
<div class="main" style="display: none;">
    <h1>Q 101. 두 디자인 시안을 충분히 확인하시고, 선호하는 디자인 시안을 선택하십시오.</h1>
    <h1>Q 101. Please check the two design plans thoroughly and choose the design plan you prefer.</h1>
    <button class="response-btn" id="respA">
        디자인 A안<br>
        Design A.
    </button>
    <button class="response-btn" id="respB">
        디자인 B안<br>
        Design B.
    </button>
</div>
<br><br>
<textarea readonly class="log" rows="7"></textarea>

<script>
    const randomId = String(self.crypto.randomUUID()).split('-').pop().slice(0, 5);
    let responseType = '';
    let responsed = false;
    const mimeType = 'video/mp4';
    const chunks = [];
    let startDate = Date.now();
    let endDate = Date.now();

    const randomIdElement = document.querySelector('span#survey-id');
    const logElement = document.querySelector('textarea.log');

    const autoDownloadBlob = (blob, filename) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        setTimeout(() => {
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }, 7000)
    };

    navigator.mediaDevices.getUserMedia({video: true}).then(async (stream) => {
        // videoElement.srcObject = stream
        // await videoElement.play()
        // const root = await navigator.storage.getDirectory();
        // const dir = await root.getDirectoryHandle('/videos', {create: true})
        // const fileHandle = await dir.getFileHandle(`${Date.now()}.mp4`, {create: true})
        // const writable = await fileHandle.createWritable()
        const recoder = new MediaRecorder(stream, {
            mimeType,
            videoBitsPerSecond: 6_000_000,
        });
        recoder.ondataavailable = (e) => {
            logElement.textContent += `${recoder.state}&`;
            if (e.data && e.data.size) chunks.push(e.data);
        };
        recoder.onstop = async () => {
            const blob = new Blob(chunks, {type: mimeType});
            // await writable.write(blob)
            // await writable.close()
            autoDownloadBlob(
                blob,
                `${randomId}-${responseType}-${startDate}-${endDate}.mp4`,
            );
            // videoElement.srcObject = null;
            stream.getTracks().forEach((t) => t.stop());
        };
        randomIdElement.addEventListener('click', () => {
            if (!responsed) {
                startDate = Date.now();
                logElement.textContent += `startDate=${startDate}&`;
                recoder.start(1000);
                document
                    .querySelector('div.logged')
                    .setAttribute('style', 'display: none;');
                document.querySelector('div.main').setAttribute('style', '');
            } else {
                window.location.reload();
            }
        });
        document.querySelectorAll('button.response-btn').forEach((element) => {
            element.addEventListener('click', () => {
                randomIdElement.textContent = randomId;
                responseType = element.id;
                responsed = true;
                logElement.textContent += `endDate=${endDate}&`;
                logElement.textContent += `responseType=${responseType}&`;
                document.querySelector('div.logged').setAttribute('style', '');
                document
                    .querySelector('div.main')
                    .setAttribute('style', 'display: none;');
                endDate = Date.now();
                document.querySelector('span#survey-message').textContent =
                    '설문을 기록하였습니다. 페이지를 조작하지 마시고 설문이 끝났음을 연구자에게 알려주십시오. Your response had been saved. Do not modify device, inform to researcher your survey ended.';
                recoder.stop();
            });
        });
    });

</script>
</body>
</html>
